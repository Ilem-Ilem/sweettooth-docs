<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Posting Engine - SweetTooth Documentation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #e0e0e0;
            padding: 40px 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #4CAF50;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #aaa;
            font-size: 16px;
        }

        .back-link {
            display: inline-block;
            color: #4CAF50;
            text-decoration: none;
            margin-bottom: 20px;
            padding: 8px 16px;
            background: #333;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .back-link:hover {
            background: #4CAF50;
            color: white;
        }

        .section {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 4px solid #4CAF50;
        }

        .section h2 {
            color: #4CAF50;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .section h3 {
            color: #2196F3;
            margin: 20px 0 10px 0;
            font-size: 16px;
        }

        .section h4 {
            color: #fff;
            margin: 15px 0 10px 0;
            font-size: 14px;
        }

        .section p {
            color: #aaa;
            line-height: 1.8;
            margin-bottom: 15px;
        }

        .workflow-diagram {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #81c784;
            overflow-x: auto;
            line-height: 2;
        }

        .table-info {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 13px;
        }

        .table-info th,
        .table-info td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #444;
        }

        .table-info th {
            color: #4CAF50;
            font-weight: 600;
        }

        .table-info td {
            color: #aaa;
        }

        .table-info code {
            background: #1a1a1a;
            padding: 2px 6px;
            border-radius: 4px;
            color: #4CAF50;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .info-box {
            background: #1b3a1b;
            border-left: 4px solid #81c784;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            color: #81c784;
        }

        .info-box.warning {
            background: #3a2a1b;
            border-left-color: #ffb74d;
            color: #ffb74d;
        }

        .info-box.info {
            background: #1e3a5f;
            border-left-color: #64b5f6;
            color: #b0d4ff;
        }

        .code-block {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #e0e0e0;
            overflow-x: auto;
        }

        .code-block .keyword {
            color: #c586c0;
        }

        .code-block .function {
            color: #dcdcaa;
        }

        .code-block .string {
            color: #ce9178;
        }

        .code-block .comment {
            color: #6a9955;
        }

        .code-block .number {
            color: #b5cea8;
        }

        ul {
            color: #aaa;
            line-height: 2;
            margin-left: 25px;
        }

        .method-card {
            background: #1a1a1a;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            border-left: 3px solid #2196F3;
        }

        .method-card h4 {
            color: #4CAF50;
            margin: 0 0 10px 0;
            font-family: 'Courier New', monospace;
        }

        .method-card p {
            margin: 0 0 10px 0;
        }

        .method-card .signature {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">← Back to Accounting Index</a>
        
        <div class="header">
            <h1>⚙️ Posting Engine</h1>
            <p>GlPostingService - Central GL entry creation and management</p>
        </div>

        <div class="section">
            <h2>Overview</h2>
            <p><code>GlPostingService</code> is the central posting engine for all accounting transactions. It creates balanced GL entries, validates accounting periods, and ensures idempotent posting behavior.</p>
            
            <div class="info-box">
                <strong>File:</strong> <code>app/Services/GlPostingService.php</code> (1599 lines)<br>
                <strong>Pattern:</strong> Single Responsibility - handles all GL entry creation<br>
                <strong>Key Feature:</strong> Idempotency protection prevents duplicate entries
            </div>
        </div>

        <div class="section">
            <h2>Core Posting Methods</h2>

            <div class="method-card">
                <h4>postSaleTransaction(Sale $sale): bool</h4>
                <p>Posts a complete sale transaction with revenue and COGS entries.</p>
                <p class="signature">Entry Types: <code>sale</code>, <code>sale_cogs</code>, <code>sale_tax</code></p>
                <ul>
                    <li>Entry A: Dr Accounts Receivable, Cr Sales Revenue (subtotal)</li>
                    <li>Entry B: Dr COGS, Cr Inventory (total cost)</li>
                    <li>Entry C: Dr AR, Cr Tax Liability (tax amount, if applicable)</li>
                </ul>
            </div>

            <div class="method-card">
                <h4>postPaymentTransaction(Payment $payment): bool</h4>
                <p>Posts a payment received, reducing AR and increasing cash/bank.</p>
                <p class="signature">Entry Type: <code>payment</code></p>
                <ul>
                    <li>Entry A: Dr Cash/Bank (method-based account), Cr Accounts Receivable</li>
                    <li>Cash account determined by payment method (cash, pos, transfer)</li>
                </ul>
            </div>

            <div class="method-card">
                <h4>postPurchaseTransaction(Purchase $purchase): bool</h4>
                <p>Posts a purchase bill, recording inventory and AP.</p>
                <p class="signature">Entry Type: <code>purchase</code></p>
                <ul>
                    <li>Entry A: Dr Inventory (landing cost), Cr Accounts Payable</li>
                    <li>Landing cost = total_fob_ngn + other_costs</li>
                </ul>
            </div>

            <div class="method-card">
                <h4>postInventoryAdjustment(StockMovement $movement): bool</h4>
                <p>Posts inventory value adjustments for damage, shrinkage, or count variance.</p>
                <p class="signature">Entry Type: <code>adjustment</code></p>
                <ul>
                    <li>Decrease: Dr Loss Account, Cr Inventory</li>
                    <li>Increase: Dr Inventory, Cr Gain Account</li>
                    <li>Only posts for type = 'damaged' or type = 'adjustment' with reason</li>
                </ul>
            </div>

            <div class="method-card">
                <h4>postAccountTransfer(AccountTransfer $transfer): bool</h4>
                <p>Posts a bank-to-bank transfer.</p>
                <p class="signature">Entry Type: <code>transfer</code></p>
                <ul>
                    <li>Entry A: Dr To Bank Account GL, Cr From Bank Account GL</li>
                </ul>
            </div>

            <div class="method-card">
                <h4>postExpenseClaim(ExpenseClaim $claim): bool</h4>
                <p>Posts employee expense claims.</p>
                <p class="signature">Entry Type: <code>expense_claim</code></p>
                <ul>
                    <li>Entry A: Dr Expense Account (per item), Cr Cash/Bank</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h2>Posting Flow</h2>
            
            <div class="workflow-diagram">
POSTING FLOW (All Transactions):

  1. OBSERVER TRIGGERS
     ↓
  2. CHECK gl_posting_status === 'pending'
     ↓ (skip if not pending)
  3. BEGIN DB TRANSACTION
     ↓
  4. VALIDATE PERIOD (getCurrentPeriod)
     ↓ (throw if no open period)
  5. IDEMPOTENCY CHECK (alreadyPosted)
     ↓ (return true if already posted)
  6. GET DEPARTMENT + GL ACCOUNTS
     ↓
  7. CREATE GlEntry RECORDS (draft status)
     ↓
  8. CALL entry->post(userId) ON EACH
     ↓
  9. UPDATE MODEL STATUS TO 'posted'
     ↓
  10. COMMIT DB TRANSACTION
     ↓
  11. RETURN true

  ON ERROR:
  - ROLLBACK transaction
  - UPDATE status to 'failed'
  - LOG error with context
  - THROW exception
            </div>
        </div>

        <div class="section">
            <h2>Idempotency Guard</h2>
            
            <p>The <code>alreadyPosted()</code> method prevents duplicate GL entries by checking if entries already exist for a given reference.</p>

            <div class="code-block">
<span class="keyword">protected function</span> <span class="function">alreadyPosted</span>(
    <span class="keyword">string</span> $referenceType, 
    <span class="keyword">int</span> $referenceId, 
    <span class="keyword">array</span> $entryTypes
): <span class="keyword">bool</span>
{
    <span class="keyword">return</span> GlEntry::where(<span class="string">'reference_type'</span>, $referenceType)
        ->where(<span class="string">'reference_id'</span>, $referenceId)
        ->whereIn(<span class="string">'entry_type'</span>, $entryTypes)
        ->where(<span class="string">'status'</span>, <span class="string">'posted'</span>)
        ->exists();
}
            </div>

            <div class="info-box info">
                <strong>Usage Example:</strong><br>
                For sales: <code>alreadyPosted(Sale::class, $sale->id, ['sale', 'sale_cogs', 'sale_tax'])</code><br><br>
                If any entry with these criteria exists and is posted, the method returns true and posting is skipped.
            </div>
        </div>

        <div class="section">
            <h2>Period Validation</h2>
            
            <p>Every posting operation validates that an open accounting period exists for the transaction date.</p>

            <div class="code-block">
<span class="keyword">public function</span> <span class="function">getCurrentPeriod</span>(): ?AccountingPeriod
{
    <span class="keyword">if</span> ($<span class="keyword">this</span>->currentPeriod) {
        <span class="keyword">return</span> $<span class="keyword">this</span>->currentPeriod;
    }
    
    <span class="keyword">return</span> AccountingPeriod::current()->first();
}

<span class="comment">// In each post method:</span>
$period = $<span class="keyword">this</span>->getCurrentPeriod();
<span class="keyword">if</span> (!$period) {
    <span class="keyword">throw new</span> Exception(<span class="string">'No open accounting period found'</span>);
}
            </div>

            <div class="info-box warning">
                <strong>Important:</strong> If posting fails with "No open accounting period found", create a new period in Accounting → Periods before processing transactions.
            </div>
        </div>

        <div class="section">
            <h2>Account Number Mapping</h2>
            
            <p>GlPostingService uses hardcoded account numbers for consistent posting. These can be overridden by department GL mappings.</p>

            <table class="table-info">
                <thead>
                    <tr>
                        <th>Account Type</th>
                        <th>Default Number</th>
                        <th>Override Method</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Revenue</td>
                        <td><code>4010</code></td>
                        <td><code>getRevenueAccountForDepartment()</code></td>
                    </tr>
                    <tr>
                        <td>Accounts Receivable</td>
                        <td><code>1100</code></td>
                        <td><code>getReceivableAccountForDepartment()</code></td>
                    </tr>
                    <tr>
                        <td>Inventory</td>
                        <td><code>1220</code></td>
                        <td><code>getGlAccount('1220')</code></td>
                    </tr>
                    <tr>
                        <td>COGS</td>
                        <td><code>5010</code></td>
                        <td><code>getGlAccount('5010')</code></td>
                    </tr>
                    <tr>
                        <td>Accounts Payable</td>
                        <td><code>2010</code></td>
                        <td><code>getGlAccount('2010')</code></td>
                    </tr>
                    <tr>
                        <td>Tax Liability</td>
                        <td><code>2020</code></td>
                        <td><code>getTaxAccountForDepartment()</code></td>
                    </tr>
                    <tr>
                        <td>Cash (method-based)</td>
                        <td><code>1010</code>, <code>1050</code>, <code>1110</code></td>
                        <td><code>getCashAccountNumberForPaymentMethod()</code></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="section">
            <h2>Error Handling</h2>
            
            <p>When posting fails, the system captures the error and allows retry without data corruption.</p>

            <div class="workflow-diagram">
ERROR HANDLING FLOW:

  try {
      DB::beginTransaction();
      // ... posting logic
      DB::commit();
      return true;
  } catch (Exception $e) {
      DB::rollBack();
      
      // Log error
      Log::error('GL Posting Error', [
          'reference_type' => $model::class,
          'reference_id' => $model->id,
          'error' => $e->getMessage(),
      ]);
      
      // Update model status
      $model->update([
          'gl_posting_status' => 'failed',
          'gl_posting_error' => $e->getMessage(),
      ]);
      
      // Log failure for monitoring
      AccountingPostingFailure::create([
          'reference_type' => get_class($model),
          'reference_id' => $model->id,
          'entry_type' => $transactionType,
          'error_message' => $e->getMessage(),
          'last_seen_at' => now(),
      ]);
      
      throw $e;
  }
            </div>

            <h3>Common Error Causes</h3>
            <ul>
                <li><strong>No open accounting period:</strong> Create new period in Period Control</li>
                <li><strong>GL account not found:</strong> Check chart of accounts seeding</li>
                <li><strong>Department GL mapping missing:</strong> Configure department defaults or ensure system defaults exist</li>
                <li><strong>Validation exception:</strong> Review entry balance (debits = credits)</li>
            </ul>
        </div>

        <div class="section">
            <h2>Department Account Resolution</h2>
            
            <p>GlPostingService resolves GL accounts through a hierarchy: Department → Payment Method → System Default.</p>

            <div class="workflow-diagram">
ACCOUNT RESOLUTION HIERARCHY:

  For Revenue:
    Department.revenue_account_id 
      → Default: 4010

  For Receivable:
    Department.receivable_account_id 
      → Default: 1100

  For Cash (Payment):
    Payment.bankAccount.glAccount 
      → Department.cash_account_id 
      → Payment method default (POS→1110, Cash→1010, Transfer→1050)

  For Tax:
    Department.tax_account_id 
      → Default: 2020
            </div>
        </div>

        <div class="section">
            <h2>GlEntry Post Method</h2>
            
            <p>Each GlEntry has a <code>post()</code> method that finalizes the entry and updates the period totals.</p>

            <div class="code-block">
<span class="keyword">public function</span> <span class="function">post</span>($postedByUserId): <span class="keyword">bool</span>
{
    <span class="comment">// Validate entry is balanced</span>
    <span class="keyword">if</span> ($<span class="keyword">this</span>->debit != $<span class="keyword">this</span>->credit) {
        <span class="keyword">throw new</span> Exception(<span class="string">'Entry must be balanced'</span>);
    }
    
    <span class="comment">// Update status</span>
    $<span class="keyword">this</span>->status = <span class="string">'posted'</span>;
    $<span class="keyword">this</span>->posted_by_id = $postedByUserId;
    $<span class="keyword">this</span>->posted_at = now();
    $<span class="keyword">this</span>->save();
    
    <span class="comment">// Update period totals (if applicable)</span>
    <span class="comment">// ... period total update logic</span>
    
    <span class="keyword">return true</span>;
}
            </div>
        </div>

        <div class="section">
            <h2>Testing Posting</h2>
            
            <h3>Manual Testing Steps</h3>
            <ul>
                <li>Create a sale with status <code>completed</code></li>
                <li>Verify SaleObserver triggers <code>postSaleTransaction()</code></li>
                <li>Check <code>gl_posting_status</code> changes to <code>posted</code></li>
                <li>Verify GlEntry records exist with correct amounts</li>
                <li>Create a payment for the sale</li>
                <li>Verify PaymentObserver triggers <code>postPaymentTransaction()</code></li>
                <li>Run Trial Balance report to confirm entries balance</li>
            </ul>

            <h3>Retry Testing</h3>
            <ul>
                <li>Manually set a transaction's <code>gl_posting_status</code> to <code>failed</code></li>
                <li>Navigate to Accounting → Posting Status</li>
                <li>Filter by status = 'failed'</li>
                <li>Click retry action</li>
                <li>Verify status changes to <code>posted</code> (if issue resolved)</li>
            </ul>
        </div>

        <div class="section">
            <h2>Quick Reference</h2>
            
            <h3>Key Files</h3>
            <ul>
                <li><strong>Service:</strong> <code>app/Services/GlPostingService.php</code></li>
                <li><strong>Model:</strong> <code>app/Models/GlEntry.php</code></li>
                <li><strong>Period Model:</strong> <code>app/Models/AccountingPeriod.php</code></li>
                <li><strong>Failure Log:</strong> <code>app/Models/AccountingPostingFailure.php</code></li>
            </ul>

            <h3>Related Documentation</h3>
            <ul>
                <li><a href="01_workflow.html" style="color: #4CAF50;">Workflow Overview</a></li>
                <li><a href="03_reports.html" style="color: #4CAF50;">Financial Reports</a></li>
                <li><a href="index.html" style="color: #4CAF50;">Back to Index</a></li>
            </ul>
        </div>
    </div>

    <script>
        window.addEventListener('load', () => {
            console.log('%c✓ Posting Engine Documentation Ready', 'color: #4CAF50; font-size: 16px; font-weight: bold;');
        });
    </script>
</body>
</html>
